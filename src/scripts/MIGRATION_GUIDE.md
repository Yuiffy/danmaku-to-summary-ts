# 从旧架构迁移到新架构指南

## 概述

本项目已从基于脚本的架构重构为基于TypeScript的模块化架构。本指南帮助您完成迁移过程。

## 主要变化

### 1. 架构变化
- **旧架构**: 独立的JavaScript脚本文件
- **新架构**: TypeScript模块化应用程序，包含服务、核心基础设施和统一入口

### 2. 配置变化
- **旧配置**: `src/scripts/config.json` 单一文件
- **新配置**: 分层配置系统
  - 默认配置: `src/core/config/defaults.json`
  - 环境配置: `config/{environment}.json`
  - 本地配置: `src/scripts/config.secrets.json`
  - 环境变量: 最高优先级

### 3. 启动方式变化
- **旧方式**: `node src/scripts/webhook_server.js`
- **新方式**: `node dist/app/main.js`

## 迁移步骤

### 步骤1: 安装依赖
```bash
# 安装TypeScript和构建工具
npm install
# 或
pnpm install
```

### 步骤2: 构建项目
```bash
# 构建TypeScript代码
npm run build
# 或
pnpm build
```

### 步骤3: 迁移配置
```bash
# 运行迁移工具
node src/scripts/migrate-to-new-architecture.js
```

### 步骤4: 更新配置
1. 检查生成的配置文件: `config/production.json`
2. 根据需要调整配置
3. 确保API密钥等敏感信息正确配置

### 步骤5: 测试运行
```bash
# 启动服务
npm start
# 或直接运行
node dist/app/main.js
```

## 兼容性说明

### 保留的兼容性
1. **配置文件**: 自动迁移旧配置到新格式
2. **启动脚本**: 创建了兼容性包装器
3. **处理逻辑**: 核心功能保持不变

### 需要更新的部分
1. **自定义脚本**: 如果创建了自定义脚本，需要更新为使用新API
2. **部署脚本**: 更新部署脚本以使用新的启动方式
3. **监控配置**: 新的健康检查端点

## 新功能

### 1. 服务管理
- 统一的启动、停止和重启
- 服务状态监控
- 健康检查端点

### 2. 改进的配置管理
- 分层配置系统
- 环境特定配置
- 配置验证

### 3. 增强的日志系统
- 结构化日志
- 多级别日志
- 文件和控制台输出

### 4. 错误处理
- 统一的错误处理
- 错误分类和恢复
- 详细的错误上下文

## 故障排除

### 常见问题

1. **服务无法启动**
   - 检查端口是否被占用
   - 检查配置文件格式
   - 查看日志文件

2. **配置迁移失败**
   - 手动检查配置文件
   - 参考默认配置格式

3. **依赖安装失败**
   - 清理node_modules重新安装
   - 检查Node.js版本（需要18+）

## 获取帮助

- 查看详细文档: [README.md](../README.md)
- 查看架构设计: [plans/](../plans/)
- 提交问题: GitHub Issues

## 下一步

1. 测试所有功能正常工作
2. 更新部署脚本
3. 配置监控和告警
4. 性能优化和调优
